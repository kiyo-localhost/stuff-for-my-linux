#!/bin/bash
set -euo pipefail
command -v notify-send >/dev/null 2>&1 && NOTIFY=true || NOTIFY=false

if [[ -t 1 ]]; then
    RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'
    BLUE='\033[0;34m'; BOLD='\033[1m'; NC='\033[0m'
else
    RED='' GREEN='' YELLOW='' BLUE='' BOLD='' NC=''
fi

if [[ $EUID -eq 0 ]]; then
    QUARANTINE="/quarantine"
else
    QUARANTINE="$HOME/.local/share/clanauto/quarantine"
fi


info()  { echo -e "${BLUE}▶${NC} $*"; }
ok()    { echo -e "${GREEN}✔${NC} $*"; }
warn()  { echo -e "${YELLOW}⚠${NC} $*"; }
err()   { echo -e "${RED}✘${NC} $*"; }
bold()  { echo -e "${BOLD}$*${NC}"; }

require_root() {
    if [[ $EUID -ne 0 ]]; then
        err "This operation requires root"
        exit 1
    fi
}

# EICAR test
eicar_test() {
    local f
    f=$(mktemp /tmp/clanauto-eicar-XXXX.txt)
    printf '%s\n' 'X5O!P%@AP\[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*' > "$f"
    clamscan "$f" >/dev/null 2>&1 || true
    rm -f "$f"
}

run_scan() {
    local SCAN_CMD="$1"
    local TARGET_DESC="$2"

    if [[ $EUID -eq 0 ]]; then
        LOG_DIR="/var/log/clanauto"
    else
        LOG_DIR="${XDG_STATE_HOME:-$HOME/.local/share}/clanauto"
    fi
    mkdir -p "$LOG_DIR"

    LOG_FILE="$LOG_DIR/scan-$(date '+%Y-%m-%d_%H-%M-%S').log"

    mkdir -p "$QUARANTINE"
    chmod 700 "$QUARANTINE" 2>/dev/null || true

    info "$TARGET_DESC"
    info "Log: $LOG_FILE"
    echo

    bash -c "$SCAN_CMD" | tee "$LOG_FILE" | sed -u 's/FOUND$/'"$RED"'FOUND'"$NC"'/'


    local INFECTED
    INFECTED=$(awk '/Infected files:/ {print $3; exit}' "$LOG_FILE" 2>/dev/null || echo 0)
    INFECTED=${INFECTED:-0}

    if [[ "$INFECTED" -gt 0 ]]; then
        err "Malware detected! ($INFECTED infected files)"
        [[ "$NOTIFY" == true ]] && notify-send -u critical \
            "Clanauto Alert" "Malware detected! Log: $LOG_FILE"
        less "$LOG_FILE"
        return 1
    else
        ok "Scan clean."
        return 0
    fi
}


usage() {
    cat <<EOF
Usage:

  clamauto -u                  Update ClamAV signatures
  clamauto -f <file>           Scan a file
  clamauto -r <folder>         Scan a folder
  clamauto -s                  Scan entire system (root; slow like hella slow but scans the full system)
  clamauto -d                  Fast scan (user-writable areas) 
  clamauto -i <file>           Inspect signature DB with sigtool
  clamauto -b <file>           List bytecode signatures for file
  clamauto -l                  View latest log
  clamauto -h                  Show help

note: ps i tryed to add the spinny spinny but if i do that i cant show the output im a bad coder lol sorry
note: if posssble do a sudo scan (tho there is a code which ask for sudo for scans that need it)
note: EICAR test string used for test scans (safe).
EOF
}

[[ $# -eq 0 ]] && usage && exit 1

while getopts "huf:r:st:i:b:ld" opt; do
    case "$opt" in
        h) usage; exit 0 ;;

        u)
            info "Updating ClamAV database..."
            sudo freshclam || { err "Update failed"; exit 1; }
            ;;
        f)
            info "Scanning file: $OPTARG"
            eicar_test
            run_scan \
              "clamscan --move=$QUARANTINE --infected --bell \"${OPTARG}\"" \
              "Scanning file: $OPTARG"
            ;;
        r)
            info "Scanning folder: $OPTARG"
            eicar_test
            run_scan \
              "clamscan -r --move=$QUARANTINE --infected --bell \"${OPTARG}\"" \
              "Scanning folder: $OPTARG"
            ;;
        s)
            info "Scanning entire system..."
            require_root
            eicar_test
            run_scan \
              "clamscan -r / --infected --bell --exclude-dir='^/sys|^/proc|^/dev|^/run|^/snap'" \
              "Full system scan"
            ;;
        t)
            if [[ "$OPTARG" == "true" ]]; then
                info "Enabling weekly scan..."
                (crontab -l 2>/dev/null; echo "0 3 * * 0 /usr/local/bin/clamautotime -s") | crontab -
            elif [[ "$OPTARG" == "false" ]]; then
                info "Disabling weekly scan..."
                crontab -l 2>/dev/null | grep -v "clamautotime -s" | crontab -
            else
                err "Use true or false"
                exit 1
            fi
            ;;
        d)
            info "Fast scan (user-writable areas)"
            eicar_test
            run_scan \
              "clamscan -r /home /etc /opt /var/www --exclude-dir='^/proc|^/sys|^/dev|^/snap|^/var/lib/docker' --infected --bell" \
              "Fast system scan (user areas)"
            ;;
        i)
            info "Inspecting signature file: $OPTARG"
            sigtool --info "$OPTARG"
            ;;
        b)
            info "Inspecting bytecode in: $OPTARG"
            sigtool --list-sigs "$OPTARG"
            ;;
        l)
            if [[ $EUID -eq 0 ]]; then
                LOG_DIR="/var/log/clanauto"
            else
                LOG_DIR="${XDG_STATE_HOME:-$HOME/.local/share}/clanauto"
            fi
            if [[ ! -d "$LOG_DIR" ]]; then
                echo "No logs found in $LOG_DIR"
                exit 0
            fi
            echo "Available scan logs:"
            ls -lh "$LOG_DIR"
            read -p "Open latest log? (y/N): " ans
            if [[ "$ans" =~ ^[Yy]$ ]]; then
                latest=$(ls -t "$LOG_DIR"/scan-*.log 2>/dev/null | head -n 1)
                [[ -n "$latest" ]] && less "$latest"
            fi
            ;;
        *)
            usage
            exit 1
            ;;
    esac
done
